//7.imageviewer.js
!function(i,e,t,n){"use strict";var a=function(){},o=i("body"),s=i(e),r=i(t);function h(i,e,t,n){return i/=n,-t*(--i*i*i*i-1)+e}!function(){for(var i=0,t=["ms","moz","webkit","o"],n=0;n<t.length&&!e.requestAnimationFrame;++n)e.requestAnimationFrame=e[t[n]+"RequestAnimationFrame"],e.cancelAnimationFrame=e[t[n]+"CancelAnimationFrame"]||e[t[n]+"CancelRequestAnimationFrame"];e.requestAnimationFrame||(e.requestAnimationFrame=function(t,n){var a=(new Date).getTime(),o=Math.max(0,16-(a-i)),s=e.setTimeout(function(){t(a+o)},o);return i=a+o,s}),e.cancelAnimationFrame||(e.cancelAnimationFrame=function(i){clearTimeout(i)})}();var m='<div class="iv-loader"></div> <div class="iv-snap-view"><div class="iv-snap-image-wrap"><div class="iv-snap-handle"></div></div><div class="iv-zoom-slider"><div class="iv-zoom-handle"></div></div></div><div class="iv-image-view" ><div class="iv-image-wrap" ></div></div>';function c(i,e){this.container=i,this.onStart=e.onStart||a,this.onMove=e.onMove||a,this.onEnd=e.onEnd||a,this.sliderId=e.sliderId||"slider"+Math.ceil(1e6*Math.random())}function l(e,t){var n=this;e.is("#iv-container")&&(n._fullPage=!0),n.container=e,t=n.options=i.extend({},l.defaults,t),n.zoomValue=100,e.find(".snap-view").length||e.prepend(m),e.addClass("iv-container"),"static"==e.css("position")&&e.css("position","relative"),n.snapView=e.find(".iv-snap-view"),n.snapImageWrap=e.find(".iv-snap-image-wrap"),n.imageWrap=e.find(".iv-image-wrap"),n.snapHandle=e.find(".iv-snap-handle"),n.zoomHandle=e.find(".iv-zoom-handle"),n._viewerId="iv"+Math.floor(1e6*Math.random())}i(function(){o.length||(o=i("body")),o.append('<div id="iv-container">'+m+'<div class="iv-close"></div><div>')}),c.prototype.init=function(){var i=this,e=(this.container,"."+this.sliderId);return this.container.on("touchstart"+e+" mousedown"+e,function(t){t.preventDefault();var n=("touchstart"==t.type?"touchmove":"mousemove")+e,a=("touchstart"==t.type?"touchend":"mouseup")+e,o=t.originalEvent,s=o.clientX||o.touches[0].clientX,h=o.clientY||o.touches[0].clientY;if(!1!==i.onStart(t,{x:s,y:h})){var m=function(e){e.preventDefault();var t=(o=e.originalEvent).clientX||o.touches[0].clientX,n=o.clientY||o.touches[0].clientY;i.onMove(e,{dx:t-s,dy:n-h,mx:t,my:n})},c=function(){r.off(n,m),r.off(a,c),i.onEnd()};r.on(n,m),r.on(a,c)}}),this},l.prototype={constructor:l,_init:function(){var i=this,e=i.options,t=!1,n=this.container,a="."+i._viewerId,o=this.snapHandle,m=this.snapImageWrap,l=this.imageWrap,d=new c(m,{sliderId:i._viewerId,onStart:function(){if(!i.loaded)return!1;var e=o[0].style;this.curHandleTop=parseFloat(e.top),this.curHandleLeft=parseFloat(e.left),this.handleWidth=parseFloat(e.width),this.handleHeight=parseFloat(e.height),this.width=m.width(),this.height=m.height(),clearInterval(u.slideMomentumCheck),cancelAnimationFrame(u.sliderMomentumFrame)},onMove:function(e,t){var n=this.curHandleLeft+100*t.dx/this.width,a=this.curHandleTop+100*t.dy/this.height;n=Math.max(0,n),n=Math.min(100-this.handleWidth,n),a=Math.max(0,a),a=Math.min(100-this.handleHeight,a);var s=i.containerDim,r=i.imageDim.w*(i.zoomValue/100),h=i.imageDim.h*(i.zoomValue/100),m=r<s.w?(s.w-r)/2:-r*n/100,c=h<s.h?(s.h-h)/2:-h*a/100;o.css({top:a+"%",left:n+"%"}),i.currentImg.css({left:m,top:c})}}).init(),u=i._imageSlider=new c(l,{sliderId:i._viewerId,onStart:function(e,n){if(!i.loaded)return!1;if(!t){var a=this;d.onStart(),a.imgWidth=i.imageDim.w*i.zoomValue/100,a.imgHeight=i.imageDim.h*i.zoomValue/100,a.positions=[n,n],a.startPosition=n,i._clearFrames(),a.slideMomentumCheck=setInterval(function(){a.currentPos&&(a.positions.shift(),a.positions.push({x:a.currentPos.mx,y:a.currentPos.my}))},50)}},onMove:function(i,e){t||(this.currentPos=e,d.onMove(i,{dx:-e.dx*d.width/this.imgWidth,dy:-e.dy*d.height/this.imgHeight}))},onEnd:function(){if(!t){var i=this,e=this.positions[1].x-this.positions[0].x,n=this.positions[1].y-this.positions[0].y;if(Math.abs(e)>30||Math.abs(n)>30){var a=1,o=i.currentPos.dx,s=i.currentPos.dy;!function t(){a<=60&&(i.sliderMomentumFrame=requestAnimationFrame(t)),o+=h(a,e/3,-e/3,60),s+=h(a,n/3,-n/3,60),d.onMove(null,{dx:-o*d.width/i.imgWidth,dy:-s*d.height/i.imgHeight}),a++}()}}}}).init(),v=0;l.on("mousewheel"+a+" DOMMouseScroll"+a,function(t){if(e.zoomOnMouseWheel&&i.loaded){i._clearFrames();var a=Math.max(-1,Math.min(1,t.originalEvent.wheelDelta||-t.originalEvent.detail)),o=i.zoomValue*(100+15*a)/100;if(o>=100&&o<=e.maxZoom?v=0:v+=Math.abs(a),!(v>5)){t.preventDefault();var s=n.offset(),r=(t.pageX||t.originalEvent.pageX)-s.left,h=(t.pageY||t.originalEvent.pageY)-s.top;i.zoom(o,{x:r,y:h}),z()}}}),l.on("touchstart"+a,function(e){if(i.loaded){var a=e.originalEvent.touches[0],o=e.originalEvent.touches[1];if(a&&o){t=!0;var s=n.offset(),h=Math.sqrt(Math.pow(o.pageX-a.pageX,2)+Math.pow(o.pageY-a.pageY,2)),m=i.zoomValue,c={x:(o.pageX+a.pageX)/2-s.left,y:(o.pageY+a.pageY)/2-s.top},l=function(e){e.preventDefault();var t=e.originalEvent.touches[0],n=e.originalEvent.touches[1],a=Math.sqrt(Math.pow(n.pageX-t.pageX,2)+Math.pow(n.pageY-t.pageY,2)),o=m+(a-h)/2;i.zoom(o,c)},d=function(){r.off("touchmove",l),r.off("touchend",d),t=!1};r.on("touchmove",l),r.on("touchend",d)}}});var p,f=0;l.on("click"+a,function(t){0==f?(f=Date.now(),p={x:t.pageX,y:t.pageY}):Date.now()-f<500&&Math.abs(t.pageX-p.x)<50&&Math.abs(t.pageY-p.y)<50?(i.zoomValue==e.zoomValue?i.zoom(200):i.resetZoom(),f=0):f=0});var g,w,M=i.snapView.find(".iv-zoom-slider");new c(M,{sliderId:i._viewerId,onStart:function(e){if(!i.loaded)return!1;this.leftOffset=M.offset().left,this.handleWidth=i.zoomHandle.width(),this.onMove(e)},onMove:function(t,n){var a=(t.pageX||t.originalEvent.touches[0].pageX)-this.leftOffset-this.handleWidth/2;a=Math.max(0,a),a=Math.min(i._zoomSliderLength,a);var o=100+(e.maxZoom-100)*a/i._zoomSliderLength;i.zoom(o)}}).init();function z(t){e.snapView&&(w||i.zoomValue<=100||!i.loaded||(clearTimeout(g),w=!0,i.snapView.css("opacity",1),t||(g=setTimeout(function(){i.snapView.css("opacity",0),w=!1},4e3))))}l.on("touchmove"+a+" mousemove"+a,function(){z()});var x={};x["mouseenter"+a+" touchstart"+a]=function(){w=!1,z(!0)},x["mouseleave"+a+" touchend"+a]=function(){w=!1,z()},i.snapView.on(x),e.refreshOnResize&&s.on("resize"+a,function(){i.refresh()}),i._fullPage&&(n.on("touchmove"+a+" mousewheel"+a+" DOMMouseScroll"+a,function(i){i.preventDefault()}),n.find(".iv-close").on("click"+a,function(){i.hide()}))},zoom:function(i,e){i=Math.round(Math.max(100,i)),i=Math.min(this.options.maxZoom,i),e=e||{x:this.containerDim.w/2,y:this.containerDim.h/2},this.options.perc=i;var t=this,n=this.options.maxZoom,a=this.zoomValue,o=this.currentImg,s=this.containerDim,r=parseFloat(o.css("left")),m=parseFloat(o.css("top"));t._clearFrames();var c=0,l=(s=t.containerDim,t.imageDim),d=(s.w-l.w)/2,u=(s.h-l.h)/2,v=s.w-d,p=s.h-u;!function s(){++c<20&&(t._zoomFrame=requestAnimationFrame(s));var l=h(c,a,i-a,20),f=l/a,g=t.imageDim.w*l/100,w=t.imageDim.h*l/100,M=-((e.x-r)*f-e.x),z=-((e.y-m)*f-e.y);M=Math.min(M,d),z=Math.min(z,u),M+g<v&&(M=v-g),z+w<p&&(z=p-w),o.css({height:w+"px",width:g+"px",left:M+"px",top:z+"px"}),t.zoomValue=l,t._resizeHandle(g,w,M,z),t.zoomHandle.css("left",(l-100)*t._zoomSliderLength/(n-100)+"px")}()},_clearFrames:function(){clearInterval(this._imageSlider.slideMomentumCheck),cancelAnimationFrame(this._imageSlider.sliderMomentumFrame),cancelAnimationFrame(this._zoomFrame)},resetZoom:function(){this.zoom(this.options.zoomValue)},_calculateDimensions:function(){var i=this,e=i.currentImg,t=i.container,n=i.snapView,a=e.width(),o=e.height(),s=t.width(),r=t.height(),h=n.innerWidth(),m=n.innerHeight();i.containerDim={w:s,h:r};var c,l,d=a/o;l=(c=a>o&&r>=s||d*r>s?s:d*r)/d,i.imageDim={w:c,h:l},e.css({width:c+"px",height:l+"px",left:(s-c)/2+"px",top:(r-l)/2+"px","max-width":"none","max-height":"none"});var u=c>l?h:c*m/l,v=l>c?m:l*h/c;i.snapImageDim={w:u,h:v},i.snapImg.css({width:u,height:v}),i._zoomSliderLength=h-i.zoomHandle.outerWidth()},refresh:function(){this.loaded&&(this._calculateDimensions(),this.resetZoom())},_resizeHandle:function(i,e,t,n){var a=this.currentImg,o=i||this.imageDim.w*this.zoomValue/100,s=e||this.imageDim.h*this.zoomValue/100,r=Math.max(100*-(t||parseFloat(a.css("left")))/o,0),h=Math.max(100*-(n||parseFloat(a.css("top")))/s,0),m=Math.min(100*this.containerDim.w/o,100),c=Math.min(100*this.containerDim.h/s,100);this.snapHandle.css({top:h+"%",left:r+"%",width:m+"%",height:c+"%"})},show:function(i,e){this._fullPage&&(this.container.show(),i&&this.load(i,e))},hide:function(){this._fullPage&&this.container.hide()},options:function(i,e){if(!e)return this.options[i];this.options[i]=e},destroy:function(i,e){var t="."+this._viewerId;return this._fullPage?(container.off(t),container.find('[class^="iv"]').off(t)):this.container.remove('[class^="iv"]'),s.off(t),null},load:function(e,t){var n=this,a=this.container;a.find(".iv-snap-image,.iv-large-image").remove(),this.container.find(".iv-snap-image-wrap").prepend('<img class="iv-snap-image" src="'+e+'" />'),this.imageWrap.prepend('<img class="iv-large-image" src="'+e+'" />'),t&&this.imageWrap.append('<img class="iv-large-image" src="'+t+'" />');var o,s=this.currentImg=this.container.find(".iv-large-image");function r(){n.loaded=!0,n.zoomValue=100,s.show(),n.snapImg.show(),n.refresh(),n.resetZoom(),a.find(".iv-loader").hide()}this.snapImg=this.container.find(".iv-snap-image"),n.loaded=!1,a.find(".iv-loader").show(),s.hide(),n.snapImg.hide(),!(o=s[0]).complete||void 0!==o.naturalWidth&&0===o.naturalWidth?i(s[0]).on("load",r):r()}},l.defaults={zoomValue:100,snapView:!1,maxZoom:500,refreshOnResize:!0,zoomOnMouseWheel:!0,manualZoom:75},e.ImageViewer=function(e,t){var n,a,o;e&&("string"==typeof e||e instanceof Element||e[0]instanceof Element)||(t=e,e=i("#iv-container")),(e=i(e)).is("img")?(a=(n=e)[0].src,o=n.attr("high-res-src")||n.attr("data-high-res-src"),e=n.wrap('<div class="iv-container" style="display:inline-block; overflow:hidden"></div>').parent(),n.css({opacity:0,position:"relative",zIndex:-1})):(a=e.attr("src")||e.attr("data-src"),o=e.attr("high-res-src")||e.attr("data-high-res-src"));var s=new l(e,t);return s._init(),a&&s.load(a,o),s},i.fn.ImageViewer=function(t){return this.each(function(){var n=i(this),a=e.ImageViewer(n,t);n.data("ImageViewer",a)})}}(window.jQuery,window,document);